---
stepsCompleted: ['step-01-init', 'step-02-discovery', 'step-03-success', 'step-04-journeys', 'step-05-domain', 'step-06-innovation', 'step-07-project-type', 'step-08-scoping', 'step-09-functional', 'step-10-nonfunctional', 'step-e-01-discovery', 'step-e-02-review', 'step-e-03-edit']
inputDocuments:
  - _bmad-output/planning-artifacts/product-brief-node-pulse-2026-01-19.md
  - docs/PRD.md
  - _bmad-output/planning-artifacts/ux-design-specification.md
workflowType: 'prd'
workflow: 'edit'
date: 2026-01-21
lastEdited: 2026-01-24
author: Kevin
editHistory:
  - date: '2026-01-24'
    changes: '整合 UX Design 发现到 PRD：1) 问题类型诊断新增"运营商路由问题" 2) 告警通知新增详情页直接链接 3) 仪表盘新增异常 TOP5 列表 4) Beacon CLI 新增实时进度、错误提示修复建议、部署耗时统计 5) 新增 UI/UX 交互模式（侧边栏、卡片展开、Toast 通知、进度可视化）'
  - date: '2026-01-24'
    changes: '修复 PRD 验证问题：1) 创建完整的 Non-Functional Requirements 章节（10 个 NFR）2) 完善 4 个 FR 的可衡量性（FR1/FR5/FR11/FR21） 3) 优化信息密度（删除"能够/简单/清晰"等填充词）'
project_name: node-pulse
classification:
  projectType: cli_tool_and_saas_b2b
  domain: general
  complexity: medium
  projectContext: greenfield
---

# Product Requirements Document - node-pulse

**Author:** Kevin
**Date:** 2026-01-21

## Success Criteria

### User Success

运维主管通过告警推送接收网络异常通知（推送渠道：Webhook），无需持续监控看板。收到告警后，在 30 秒内登录 NodePulse 看板，定位问题根源（节点本地故障 vs. 跨境链路问题），无需临时部署云主机进行手动检测。

### Business Success

MVP 完成后，团队验证 NodePulse 架构的可行性：
- Beacon 部署在海外节点，采集网络质量数据
- Pulse 中心系统接收并展示 Beacon 上报的数据
- 验证从零搭建的系统支撑基本监控场景

### Technical Success

- Beacon 到 Pulse 的数据上报延迟 ≤ 5 秒
- 仪表盘加载时间 ≤ 5 秒
- Webhook 告警推送成功率 ≥ 95%
- 系统支持至少 10 个 Beacon 节点同时运行

### Measurable Outcomes

- **部署成功**：Beacon 在 Linux AMD64 节点上成功安装，向 Pulse 注册成功，Pulse 能看到节点在线状态
- **数据可见**：Pulse 仪表盘显示 Beacon 采集的时延、丢包率、抖动等核心指标
- **告警可用**：配置告警规则后，当指标超阈值时，Webhook 推送成功
- **根因定位**：仪表盘区分节点本地故障和跨境链路问题，显示诊断信息

## Product Scope

### MVP - Minimum Viable Product

**Pulse Beacon (CLI 工具):**
- Linux AMD64 架构支持
- TCP/UDP Ping 探测
- 核心指标采集：时延、丢包率、抖动
- 向 Pulse 上报数据（HTTP/HTTPS）
- 本地配置文件（YAML）
- Prometheus Metrics 接口暴露

**Pulse (Web 平台):**
- Beacon 注册管理（添加/删除/查看节点）
- 数据接收与存储
- 仪表盘（节点列表、单节点详情、健康状态指示）
- 基础告警规则配置（阈值告警）
- Webhook 告警推送
- 健康检查（验证系统功能正常）

### Growth Features (Post-MVP)

- ICMP Ping、MTR、Traceroute、Iperf3 探测方式
- 告警记录查询与管理
- 历史数据查看（7 天以上）
- 报表导出（CSV/Excel）
- 告警推送多渠道支持（邮件、钉钉、企业微信等）
- Prometheus Alertmanager 集成

### Vision (Future)

- 多协议探测能力（完整支持 ICMP/TCP/UDP/MTR/Traceroute/Iperf3）
- 业务流量抓包监控
- 自愈能力
- AI 异常模式识别
- 跨境链路拓扑可视化
- 多云节点适配（AWS/Azure/GCP）

## User Journeys

### 用户 1：运维主管 - 张主管

**开场场景**

周五下午三点，张主管收到了三个客户的投诉：美国西海岸用户说服务响应很慢，东京节点客户说偶尔掉线，新加坡节点客户说延迟明显升高。张主管习惯性地开始准备：申请临时云主机、SSH 登录、手动运行 ping/traceroute、把控制台截图发到群里、然后凭感觉判断"可能是美国机房网络不好"、"新加坡可能国际出口拥堵"。他知道这种判断太主观，而且没有历史数据对比，但这就是他唯一的办法。

他感到很无力——手里有几十个海外节点，但不知道哪个真的有问题，哪个是虚惊一场，甚至不知道问题在节点本地还是跨境链路上。

**发展动作**

这时，他的手机震动了一下。一条钉钉消息："【NodePulse 告警】新加坡节点丢包率超过 30%，持续 5 分钟"。

张主管快速点击消息中的链接，5 秒内打开了 NodePulse 仪表盘。他一眼看到了全局视图——美国节点绿色（正常）、新加坡节点红色（异常）、东京节点黄色（预警）。他点进新加坡节点详情页，看到：
- 丢包率：45%（红色，阈值 30%）
- 时延：890ms（黄色）
- 最近 7 天趋势图：曲线在半小时前开始急剧上升
- 问题类型：跨境链路问题（系统判断）

他点击"对比视图"，看到同一地区其他节点都是正常的，而新加坡节点到国内链路异常，明确了问题不在节点本地，而是跨境链路。

**高潮时刻**

张主管现在不需要猜测了。他有客观数据：丢包率 45%，7 天基线是 5%，问题明确是跨境链路。他直接在系统里创建工单："新加坡节点跨境链路异常，需协调运营商排查"，并附上了 NodePulse 的截图和数据链接。

15 分钟后，工单被处理。客户在 2 小时后反馈问题缓解了。

**结局**

一个月后，张主管用 NodePulse 发现了持续表现不佳的日本节点。他导出了 7 天数据对比，发现日本节点的时延始终比同地区其他节点高 200ms。他拿着客观数据去找技术总监，申请替换节点。技术总监问"真的有必要吗？"张主管打开 NodePulse，展示了日本节点 vs 其他节点的对比图表，说"你看，两周数据，差距很明显"。节点批准替换了。

张主管再也不需要临时部署云主机了。他每天早上打开 NodePulse 看一眼全局状态，有问题时系统主动告警。他有了数据支撑做决策，也不再凭感觉了。

---

### 用户 2：运维工程师 - 小李

**开场场景**

小李接到了张主管的指令："下周在美国东部、西欧、东京新增三个监控节点，部署 Pulse Beacon"。

他以前部署监控脚本都是这样的：写脚本、传到服务器、改权限、手动配置目标 IP、测试是否运行、自己写个定时任务记录结果。经常脚本在某种网络环境下不工作，排查起来非常痛苦。

这次，张主管发给他一个 NodePulse Beacon 的下载链接和安装脚本。

**发展动作**

小李 SSH 登录到美国东部服务器，下载了 Beacon 二进制文件。他创建了一个配置文件 `beacon.yaml`：

```yaml
pulse_server: https://pulse.example.com
node_id: us-east-01
node_name: "美国东部-节点01"
probes:
  - type: tcp_ping
    target: 8.8.8.8
    interval: 300
  - type: udp_ping
    target: 8.8.8.8
    interval: 300
```

他运行 `./beacon start`，看到命令行输出：

```
[INFO] Starting NodePulse Beacon v1.0.0...
[INFO] Loading configuration from beacon.yaml...
[INFO] Registering to Pulse server at https://pulse.example.com...
[INFO] Registration successful! Node ID: us-east-01
[INFO] Starting probes: tcp_ping, udp_ping
[INFO] Heartbeat established. Reporting every 60 seconds.
```

他打开 NodePulse 的网页，登录后在"节点管理"页面看到了新的节点，状态显示"在线"。几秒钟后，他看到"最新数据"列开始出现数值：时延 120ms，丢包率 2%。

小李觉得很顺利。他又登录到西欧和东京服务器，重复了同样的过程。三个节点都成功注册了。

**高潮时刻**

一周后，张主管找到小李："美国东部的 Beacon 掉线了，帮我看看什么问题"。

小李 SSH 登录到美国东部服务器，检查 Beacon 进程：

```bash
$ ./beacon status
```

输出显示：

```
[ERROR] Connection to Pulse server failed: Connection timeout
[INFO] Last successful heartbeat: 2026-01-22 10:45:23 UTC
[INFO] Current time: 2026-01-22 11:30:15 UTC (45 minutes ago)
[INFO] Retrying connection in 30 seconds...
[INFO] Configured Pulse server: https://pulse.example.com
```

小李检查网络连通性：

```bash
$ curl -I https://pulse.example.com
curl: (7) Failed to connect to pulse.example.com port 443 after 30000ms: Connection timeout
```

他意识到是网络问题导致无法连接 Pulse，不是 Beacon 本身的问题。他检查防火墙规则，确认 443 端口是开放的。他 ping 了 Pulse 服务器，发现路由绕路了。

他给网络团队发了消息："美国东部到 Pulse 服务器的网络路由异常，请检查"。30 分钟后，网络团队修复了路由问题。

小李再次检查 Beacon 状态：

```
[INFO] Connection to Pulse server established.
[INFO] Sending data...
[INFO] Heartbeat normal.
```

NodePulse 页面上的节点状态变回了绿色。

**结局**

小李很快适应了使用 Beacon。配置文件直观，出现问题时有结构化错误信息。部署新节点时，他只需要写一个 YAML 配置，运行 `./beacon start` 就可以了。当 Beacon 无法注册时，CLI 状态命令能帮他定位问题层级（Beacon/网络/配置）。

小李的部署时间从原来的 1-2 小时缩短到了 10 分钟。

---

### 用户 3：运维工程师 - 故障排查（小李的扩展旅程）

**开场场景**

周五晚上 11 点，小李刚准备下班，收到告警：东京节点断连了。他 SSH 登录服务器，发现 Beacon 进程还在运行，但状态显示"无法连接到 Pulse"。

**发展动作**

小李先检查 Beacon 的本地日志：

```
$ cat /var/log/beacon/beacon.log
```

日志显示：

```
2026-01-22T22:00:15Z [INFO] Heartbeat sent
2026-01-22T22:01:15Z [WARN] Pulse server response time: 5800ms
2026-01-22T22:02:15Z [ERROR] Pulse server timeout (response > 10s)
2026-01-22T22:03:15Z [ERROR] Connection lost. Retrying...
2026-01-22T22:04:15Z [WARN] Retry failed. Connection timeout.
```

同时，其他节点都是正常的，说明 Pulse 服务本身没问题。小李检查本地网络：

```bash
$ ping 8.8.8.8
64 bytes from 8.8.8.8: icmp_seq=1 ttl=55 time=120ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=55 time=115ms
```

网络到公网是正常的。他检查到 Pulse 服务器的连通性：

```bash
$ telnet pulse.example.com 443
Trying 10.0.0.1...
Connected to pulse.example.com.
Escape character is '^]'.
```

端口是通的。小李意识到可能是 Pulse 服务器的负载问题或者 Beacon 的重连机制有问题。

他运行：

```bash
$ ./beacon debug
```

调试模式输出调试信息，发现 Beacon 在重连时没有正确处理服务器返回的 429 Too Many Requests 错误。

**高潮时刻**

小李找到了根本原因：东京节点的网络波动导致短时间内发送了过多重连请求，Pulse 服务器限制了该节点的请求频率。Beacon 的重连逻辑没有正确处理 429 错误，导致陷入重连失败循环。

他调整了 Beacon 配置，增加重连间隔：

```yaml
pulse_server: https://pulse.example.com
reconnect:
  max_retries: 10
  retry_interval: 60  # 从 30 秒改到 60 秒
  backoff: exponential
```

重启 Beacon 后，问题解决了。

**结局**

小李把这个问题记录下来，准备反馈给 Beacon 的开发团队作为改进点。通过 Beacon 的日志和调试功能，他定位问题是在网络层、配置层还是应用层。

---

### Journey Requirements Summary

基于以上用户旅程，NodePulse MVP 需要以下核心能力：

### 运维主管的旅程揭示的需求：
- **告警推送**：通过 Webhook 推送异常通知（钉钉等渠道）
- **全局仪表盘**：单页面查看所有节点健康状态（红/黄/绿三色）
- **节点详情视图**：点击节点查看指标（时延、丢包率、抖动）
- **历史趋势图**：7 天数据可视化，支持对比
- **问题类型判断**：自动区分节点本地故障 vs. 跨境链路问题
- **多节点对比**：支持同地区/不同地区节点指标对比
- **数据导出**：导出 7 天数据用于决策支持

### 运维工程师的旅程揭示的需求：
- **Beacon CLI 工具**：支持 start/stop/status/debug 等命令
- **YAML 配置文件**：基于 YAML 的配置格式
- **自动注册机制**：启动时向 Pulse 注册，获取 Node ID
- **状态指示**：启动时输出注册成功/失败信息
- **心跳机制**：定期向 Pulse 上报数据（60 秒间隔）
- **本地日志**：记录运行状态和错误信息
- **调试模式**：提供调试输出（网络状态、配置解析、连接重试）用于故障排查
- **Pulse 节点管理**：Web 界面查看所有已注册节点
- **节点在线状态**：显示每个节点的连接状态

---

## Domain-Specific Requirements

### Compliance & Regulatory
- 无特定合规要求

### Technical Constraints
- **数据传输安全**：Beacon 与 Pulse 之间采用 TLS 加密传输
- **Beacon 资源限制**：
  - 内存占用 ≤ 100M
  - CPU 占用 ≤ 100 微核

### Integration Requirements
- **Prometheus Metrics 接口**：Beacon 暴露 `/metrics` 端点供 Prometheus 抓取
- **Webhook 告警推送**：Pulse 支持通过 Webhook 推送告警到第三方系统

### Risk Mitigations
- **跨境网络数据丢失**：
  - 数据传输采用压缩机制
  - 支持断点续传，网络恢复后自动同步数据
- **ICMP 禁用环境适配**：
  - 优先使用 TCP/UDP Ping 探测
  - 当 ICMP 不可用时自动回退到 TCP/UDP
- **Beacon 资源占用监控**：
  - 监控 CPU 和内存使用
  - 超过限制时告警并自动降级采集频率

## Project-Type Specific Requirements (CLI Tool + SaaS B2B)

### Project-Type Overview
NodePulse 采用 CLI 工具（Pulse Beacon）与 SaaS B2B Web 平台（Pulse）的混合架构，专为海外网络监控场景设计。

### Technical Architecture Considerations

**Pulse Beacon (CLI 工具):**
- 静态二进制：单文件部署，无运行时依赖
- 配置驱动：YAML 配置文件定义探测目标、上报间隔、心跳频率等
- 命令行界面：支持 start/stop/status/debug 等核心命令
- 日志系统：结构化日志输出（INFO/WARN/ERROR 级别）到文件和控制台

**Pulse (Web 平台):**
- REST API：Beacon 数据上报通过 HTTP/HTTPS API
- 单体架构：MVP 阶段简化运维，预留集群扩展能力
- 基础认证：账号密码登录
- 数据处理：内存中缓存数据（7 天），确保查询性能

### CLI Tool Specific Requirements

**命令行交互:**
- 交互模式：支持交互式命令（如 `./beacon start`, `./beacon stop`, `./beacon status`, `./beacon debug`）
- 输出格式：
  - 标准输出：结构化日志级别（INFO/WARN/ERROR）
  - 状态输出：JSON 格式便于程序化解析
- 脚本支持：通过配置文件批量部署和自动化操作
- 配置热更新：支持 YAML 配置文件热更新，无需重启进程

**本地日志与调试:**
- 日志到文件：`/var/log/beacon/beacon.log` 自动轮转
- 调试模式：`./beacon debug` 输出诊断信息，包括网络状态、配置解析、连接重试等

### SaaS B2B Specific Requirements

**基础认证与权限:**
- 单租户部署：MVP 阶段团队内部使用
- 三种预设角色：
  - 管理员：所有权限（节点管理、告警配置、系统设置）
  - 操作员：执行探测配置、告警处理、数据查看
  - 查看员：仅查看仪表盘数据，无配置权限
- 权限控制：按功能模块限制访问（如：操作员可以修改探测配置但不能删除节点）

**集成能力:**
- Webhook API：支持配置第三方 Webhook URL，自动推送告警事件
- Prometheus Metrics 接口：
  - Beacon 端点：暴露 `/metrics` 端点供 Prometheus 抓取
  - 标准格式：遵循标准监控接口格式
  - 核心指标：`beacon_up`, `beacon_rtt_seconds`, `beacon_packet_loss_rate`, `beacon_jitter_ms`

**UI/UX 交互模式:**
- 侧边栏导航：左侧固定侧边栏用于主要模块切换（仪表盘、节点管理、告警配置、系统设置）
- 卡片展开详情：点击节点卡片无需翻页直接展开详情，减少点击次数
- Toast 通知：操作成功或失败的即时反馈（"节点添加成功"、"配置已保存"、"连接失败"），短暂显示后自动消失
- 进度可视化：分步骤进度显示（1/4、2/4、3/4、4/4），用户始终知道操作进度

### Implementation Considerations

**部署方式:**
- **Beacon**：静态二进制文件 + YAML 配置，支持一键安装脚本简化部署流程
- **Pulse**：容器化部署，通过环境变量配置数据库连接、端口等

**技术栈:**
- **Beacon**：编译型二进制 + 标准库（网络协议包用于 TCP/UDP 探测，JSON 编码用于配置解析）
- **Pulse**：编译型二进制 + Web 服务器 + 内存缓存（7 天数据）

## Functional Requirements

### 数据采集与管理

#### FR1：运维工程师可以管理 Beacon 节点
**作为运维工程师**，我可以添加、删除和查看所有 Beacon 节点。

**接受条件：**
- 节点必须包含：节点 ID、节点名称、IP 地址、地区标签
- 节点必须关联探测配置（探测类型、目标、间隔）
- 删除节点前需要确认（防止误删）

**约束条件：**
- 添加节点时必须提供基础信息（IP、名称）
- 删除节点时需要确认（防止误删）
- 节点管理操作响应时间 P95 ≤ 10 秒（在 10 个节点场景下）
- 支持同时显示最多 50 个节点

#### FR2：运维工程师可以配置 Beacon 的探测参数
**作为运维工程师**，我可以为每个 Beacon 配置探测目标、协议类型、探测间隔等参数。

**接受条件：**
- 支持配置多个探测任务
- 每个探测任务包含：探测类型（TCP/UDP）、目标 IP、端口、间隔、超时时间、探测次数

**约束条件：**
- 探测协议仅支持 TCP/UDP（MVP 阶段）
- 探测间隔可配置范围：60-300 秒（默认 300 秒）
- 探测次数可配置范围：1-100 次（默认 10 次）
- 配置变更支持热更新（无需重启 Beacon）

#### FR3：运维工程师可以查看 Beacon 的状态
**作为运维工程师**，我可以查看所有 Beacon 的在线/离线状态、最后心跳时间、最新数据上报时间。

**接受条件：**
- 显示节点连接状态（在线/离线/连接中）
- 显示每个节点的最后心跳时间
- 显示每个节点的最新数据上报时间

**约束条件：**
- 状态刷新周期 ≤5 秒
- 需要显示最后心跳时间（用于判断节点是否离线）
- 需要显示数据上报时间（用于判断数据是否正常）

#### FR4：运维工程师可以查看 Pulse 的仪表盘
**作为运维主管**，我可以在仪表盘上查看所有节点的网络质量数据和健康状态。

**接受条件：**
- 仪表盘加载时间 ≤5 秒
- 显示全局节点列表，支持红/黄/绿健康状态指示
- 显示单节点详情页，包含时延、丢包率、抖动等指标
- 显示 7 天历史趋势图
- 全局视图显示异常 TOP5 列表（按严重程度排序）

**约束条件：**
- 仪表盘数据必须从内存缓存加载（7 天数据）
- 历史数据必须按时间聚合（每分钟或每 5 分钟）

---

### 告警与通知

#### FR5：运维主管可以配置告警规则
**作为运维主管**，我可以配置网络指标的告警阈值和规则。

**接受条件：**
- 支持配置时延、丢包率、抖动的阈值告警
- 支持按节点或分组应用告警规则
- 告警级别分为严重（P0）、一般（P1）、提醒（P2）

**约束条件：**
- 阈值配置必须支持数值验证
- 告警规则支持启用/禁用
- 告警抑制机制：同一节点同一类型异常在 5 分钟内仅推送一次
- **告警阈值默认值：**
  - 时延警告阈值：> 500ms
  - 时延严重阈值：> 800ms
  - 丢包率警告阈值：> 10%
  - 丢包率严重阈值：> 30%
  - 抖动警告阈值：> 50ms
  - 抖动严重阈值：> 100ms

#### FR6：运维主管可以配置 Webhook 告警推送
**作为运维主管**，我可以配置 Webhook URL，将告警事件自动推送到第三方系统。

**接受条件：**
- 支持配置一个或多个 Webhook URL
- Webhook 告警使用 HTTP POST 请求
- Webhook 请求格式符合 JSON 规范
- 支持自定义告警事件格式
- 告警通知包含直接链接到异常节点详情页

**约束条件：**
- Webhook URL 必须是有效的 HTTPS 地址
- Webhook 请求必须包含认证信息（如需要）
- Webhook 响应超时时间 ≤10 秒
- 失败重试次数限制：最多 3 次
- 告警链接支持会话未过期时免登录跳转，或自动登录后跳转

#### FR7：运维主管可以查看告警记录
**作为运维主管**，我可以查看历史告警记录，包括告警时间、节点信息、告警级别、处理状态。

**接受条件：**
- 支持按节点筛选告警记录
- 支持按时间范围筛选告警记录
- 支持按告警级别筛选告警记录
- 显示告警处理状态（未处理/处理中/已解决）
- 告警记录留存时间 ≥30 天

---

### 网络探测

#### FR8：Beacon 可以执行 TCP Ping 探测
**作为 Beacon**，我可以使用 TCP 探测包探测目标 IP 和端口的连通性。

**接受条件：**
- 探测目标必须是有效的 IP 地址或域名
- 探测端口必须是有效的端口号（1-65535）
- 探测超时时间可配置范围：1-30 秒（默认 5 秒）
- 探测结果包含：连通性（成功/失败）、往返时延

**约束条件：**
- TCP 探测不依赖 ICMP（适用于 ICMP 禁用环境）
- 探测结果精确到毫秒级
- 探测失败时返回明确错误信息

#### FR9：Beacon 可以执行 UDP Ping 探测
**作为 Beacon**，我可以使用 UDP 包探测目标 IP 和端口的连通性。

**接受条件：**
- 探测目标必须是有效的 IP 地址或域名
- 探测端口必须是有效的端口号（1-65535）
- 探测超时时间可配置范围：1-30 秒（默认 5 秒）
- 探测结果包含：连通性（成功/失败）、丢包率

**约束条件：**
- UDP 探测适用于 ICMP 禁用环境
- UDP 是无连接协议，探测结果不代表真实连接状态
- 丢包率通过发送未确认包计算（发送包数 / 接收确认数）

#### FR10：Beacon 可以采集核心网络指标
**作为 Beacon**，我可以采集时延、丢包率、抖动等核心网络质量指标。

**接受条件：**
- 时延指标：往返时延（RTT）、时延方差
- 丢包率指标：发送丢包率
- 抖动指标：时延抖动
- 采样次数：每次探测至少采集 10 个样本点

**约束条件：**
- 时延测量精度 ≤1 毫秒
- 丢包率计算为 0-100% 百分比
- 数据采集频率可配置（默认 5 分钟）

---

### 配置与管理

#### FR11：Beacon 可以通过 YAML 配置文件管理配置
**作为 Beacon**，我可以通过 YAML 配置文件配置探测参数、Pulse 服务器地址、上报间隔等。

**接受条件：**
- 配置文件格式为 YAML（UTF-8 编码）
- 配置文件包含所有必需字段（pulse_server、node_id、node_name、probes）
- 配置文件支持热更新（无需重启 Beacon）
- 配置文件支持热更新（无需重启 Beacon）
- 配置文件变更在 10 秒内生效

**约束条件：**
- 配置文件必须位于指定目录（默认 `/etc/beacon/` 或当前目录）
- 配置文件必须通过验证（格式、字段完整性）
- 配置热更新不中断正在运行的探测任务

#### FR12：Beacon 支持 CLI 命令行操作
**作为 Beacon**，我可以通过命令行界面执行启动、停止、状态查看和调试等操作。

**接受条件：**
- 支持 start 命令：启动 Beacon 进程，加载配置并开始探测
  - 显示进度（"正在连接到 Pulse..."、"正在注册..."、"上传配置..."）
  - 部署完成显示耗时统计（"部署完成！用时 X 分钟"）
- 支持 stop 命令：优雅停止 Beacon 进程，等待当前探测完成
- 支持 status 命令：查看 Beacon 运行状态（在线/离线、最后心跳、配置版本）
- 支持 debug 命令：启用调试输出，帮助故障排查
  - 错误提示包含具体位置和修复建议（如配置文件行号和期望格式）
  - 支持分步骤进度显示（1/4、2/4、3/4、4/4）

**约束条件：**
- 所有命令输出成功/失败信息
- status 命令输出格式为 JSON（便于解析）
- debug 命令输出格式为结构化日志（包含网络状态、配置信息、连接重试等）
- 错误提示包含具体位置和修复建议（示例："配置格式错误：第 5 行缩进应为 2 个空格，实际是 4 个空格"）

---

### 系统与运维

#### FR13：Pulse 可以管理用户认证
**作为 Pulse**，系统支持账号密码登录，验证用户身份。

**接受条件：**
- 账号密码登录（8-32 字符）
- 账号密码必须通过加密方式存储（bcrypt）
- 登录会话超时时间为 24 小时
- 登录失败 5 次后账户锁定 10 分钟

**约束条件：**
- 单租户部署（MVP 阶段不支持多租户）
- 账号创建仅通过管理员操作
- 暂不支持 OAuth 等第三方登录方式

---

### 系统与运维

#### FR14：Pulse 可以接收 Beacon 心跳上报
**作为 Pulse**，系统可以接收 Beacon 定期上报的网络质量数据，并存储在内存缓存中。

**接受条件：**
- 心跳上报使用加密传输（HTTPS）
- 心跳数据包含：节点 ID、时延、丢包率、抖动、上报时间戳
- 心跳数据验证：验证节点 ID 是否有效、指标值是否在合理范围

**约束条件：**
- 心跳数据必须在 5 秒内接收并开始处理
- 心跳数据重复上报需要包含新的时间戳
- 数据验证失败时返回 400 错误码

#### FR15：Pulse 可以将 Beacon 数据存储到内存缓存
**作为 Pulse**，系统可以将接收到的 Beacon 心跳数据存储在内存缓存中，供仪表盘查询（7 天数据）。

**接受条件：**
- 内存缓存支持至少 10 个节点的数据
- 内存缓存数据按 1 分钟聚合数据（用于趋势图显示）
- 缓存数据保留时间：7 天
- 超过时间的数据自动清除

**约束条件：**
- 内存缓存大小需要根据节点数量和保留时间配置
- 数据聚合统计按节点 ID、时间范围
- 清除策略：数据过期策略（先进先出或最近最少使用）

#### FR16：Pulse 可以提供系统健康检查 API
**作为 Pulse**，系统提供健康检查 API，验证所有组件运行状态。

**接受条件：**
- 健康检查返回整体系统状态（健康/异常）
- 包含组件状态检查：数据库连接、Beacon 连接数、API 响应延迟、内存使用
- 健康检查可手动触发或定时触发（默认每分钟）

**约束条件：**
- 健康检查 API 响应时间 ≤100ms
- 异常状态需要返回具体错误信息
- 健康检查结果需要记录到系统日志

#### FR17：Pulse 可以管理 Beacon 节点注册
**作为 Pulse**，系统可以管理 Beacon 节点的注册、更新和删除操作。

**接受条件：**
- 支持 Beacon 注册：接收注册请求，分配 Node ID
- 支持 Beacon 更新：接收更新请求，修改节点信息
- 支持 Beacon 删除：接收删除请求，移除节点信息
- 注册请求必须包含：节点名称、节点 IP、地区标签

**约束条件：**
- Node ID 必须唯一（自动生成 UUID）
- 注册失败时返回结构化错误信息
- 删除操作需要确认（防止误删）

---

### 历史数据分析

#### FR18：Pulse 可以提供 7 天历史趋势图
**作为运维主管**，我可以在仪表盘上查看单个节点 7 天的历史网络指标趋势图。

**接受条件：**
- 趋势图显示时间范围：最近 24 小时、最近 7 天、最近 30 天
- 趋势图显示指标：时延、丢包率、抖动
- 趋势图数据从内存缓存加载（7 天数据）
- 趋势图支持数据点悬停，显示具体时间点的数值

**约束条件：**
- 趋势图数据必须按时间聚合（每分钟或每 5 分钟）
- 趋势图必须包含 7 天基线参考线（绿色虚线）
- 趋势图支持缩放功能（鼠标滚轮放大/缩小）

#### FR19：Pulse 可以支持多节点对比视图
**作为运维主管**，我可以在仪表盘上同时对比 2-5 个节点的网络指标，便于性能对比。

**接受条件：**
- 支持按地区标签分组对比
- 支持按运营商标签分组对比
- 支持自定义节点选择（最多 5 个）
- 对比图表使用相同时间范围和指标类型
- 对比视图显示：平均值、最大值、最小值、差异

**约束条件：**
- 对比节点必须有重叠的时间数据
- 对比指标必须使用相同聚合方式（平均、最大、最小）
- 对比视图必须明确标注差异（用颜色或图标）

#### FR20：Pulse 可以导出节点数据报表
**作为运维主管**，我可以导出节点网络质量数据报表，用于数据分析和汇报。

**接受条件：**
- 支持按节点筛选导出
- 支持按时间范围筛选导出（最近 7 天、最近 30 天）
- 支持按指标类型筛选导出（时延、丢包率、抖动）
- 导出文件格式：CSV（UTF-8 编码）、Excel

**约束条件：**
- 单次导出最多支持 50 个节点
- 导出文件大小限制：10MB
- 导出操作需要管理员权限
- 异步导出，完成后通过邮件或系统消息通知

#### FR21：Pulse 可以查看仪表盘加载性能指标
**作为运维主管**，系统可以显示仪表盘加载性能指标，用于评估系统响应速度。

**接受条件：**
- 指标包含：仪表盘加载时间（P99、P95）
- 仪表盘加载时间 P99 ≤ 3 秒（并发 10 用户）
- 仪表盘加载时间 P95 ≤ 2 秒（并发 10 用户）
- API 响应时间 P99 ≤ 500ms
- API 响应时间 P95 ≤ 200ms
- 数据查询时间 P99 ≤ 300ms
- 数据查询时间 P95 ≤ 200ms

**约束条件：**
- 指标数据每分钟记录一次
- 性能目标必须在系统监控仪表盘上可视化显示
- 异常性能告警：当指标超过目标值时触发告警

---

### 问题类型诊断

#### FR22：Pulse 可以自动判断问题类型
**作为 Pulse**，系统可以基于多个节点的数据对比自动判断问题类型（节点本地故障 vs. 跨境链路问题 vs 运营商路由问题）。

**接受条件：**
- 判断逻辑：基于同一地区节点的对比分析
- 判断依据：单个节点异常 vs 多个节点异常 vs 运营商路由特征
- 问题类型：节点本地故障、跨境链路问题、运营商路由问题
- 判断结果显示：在仪表盘上明确标注

**约束条件：**
- 需要至少 3 个节点数据参与对比
- 对比时间窗口：最近 1 小时
- 判断置信度：高（>90%）、中（70-90%）、低（<70%）
- 判断结果更新（问题变化时自动调整）

---

---

## Non-Functional Requirements

本章节定义 NodePulse 的非功能性需求，包括性能、可靠性、安全性、可扩展性和可维护性等质量属性。

### 性能要求

#### NFR-PERF-001: Beacon 到 Pulse 数据上报延迟
**作为系统**，Beacon 向 Pulse 上报网络质量数据的延迟应满足性能要求。

**接受条件：**
- Beacon 到 Pulse 的数据上报延迟 ≤ 5 秒（在正常网络条件下）
- 延迟测量基于时间戳差
- 延迟统计基于 100 个样本的平均值

**约束条件：**
- 在网络波动或拥堵情况下允许延迟超过 5 秒
- 延迟统计应排除异常值（如超过 P95 的值）

**重要性：** 影响监控数据时效性和运维决策效率。

---

#### NFR-PERF-002: 仪表盘加载性能
**作为运维主管**，我可以在 5 秒内加载完整的仪表盘界面。

**接受条件：**
- 仪表盘加载时间 P99 ≤ 3 秒（99 分位的请求）
- 仪表盘加载时间 P95 ≤ 2 秒（95 分位的请求）
- 支持最多 10 个并发用户同时查看仪表盘
- 加载时间从页面加载开始到完整渲染结束计算

**约束条件：**
- 性能测试应在最多 10 个并发用户环境下验证
- 加载时间不包含网络资源加载时间

**重要性：** 影响用户体验和系统可用性感知。

---

#### NFR-PERF-003: API 响应性能
**作为系统**，Pulse API 的响应时间应满足性能要求。

**接受条件：**
- API 响应时间 P99 ≤ 500ms
- API 响应时间 P95 ≤ 200ms
- 数据查询时间 P99 ≤ 300ms

**约束条件：**
- 性能指标每分钟记录一次
- 异常性能告警：当指标超过目标值时触发告警

**重要性：** 确保系统整体响应速度。

---

### 可靠性要求

#### NFR-REL-001: Webhook 告警推送可靠性
**作为系统**，Webhook 告警推送应达到高可靠性标准。

**接受条件：**
- Webhook 告警推送成功率 ≥ 95%（在 24 小时期间统计）
- 成功率计算 = 成功的 HTTP 2xx 响应次数 / 总推送次数
- 推送失败应记录原因（连接超时、服务端错误、客户端错误）

**约束条件：**
- 失败重试最多 3 次，避免消息风暴
- 重试间隔应指数退避（1 秒、2 秒、4 秒）

**重要性：** 确保关键异常能够及时通知到用户。

---

#### NFR-REL-002: Beacon 节点在线稳定性
**作为系统**，Beacon 节点的在线稳定性应满足可靠性要求。

**接受条件：**
- Beacon 节点 24 小时在线率 ≥ 99%
- 心跳丢失率 ≤ 1%（24 小时统计）

**约束条件：**
- 心跳间隔为 60 秒
- 在网络故障情况下允许短暂中断

**重要性：** 确保监控数据的连续性和完整性。

---

### 可扩展性要求

#### NFR-SCALE-001: 系统并发支持能力
**作为系统**，系统应支持至少 10 个 Beacon 节点同时运行和上报。

**接受条件：**
- 系统支持至少 10 个 Beacon 节点同时在线
- 系统支持 10 个节点同时发送心跳（60 秒间隔）
- 在 10 个节点并发上报场景下，API 响应时间 P99 ≤ 1 秒
- 心跳间隔为 60 秒时，系统能够在 1 分钟内处理所有 10 个节点的并发心跳

**约束条件：**
- 超过 10 个节点的场景不作为 MVP 性能目标
- 心跳时间戳应精确到秒级别

**重要性：** 确保 MVP 阶段的监控规模需求得到满足。

---

### 安全性要求

#### NFR-SEC-001: Beacon-Pulse 通信加密
**作为系统**，Beacon 与 Pulse 之间的通信应使用安全加密协议。

**接受条件：**
- Beacon 与 Pulse 之间的通信使用 TLS 1.2 或更高版本加密
- 支持 TLS 握手协议版本日志记录

**约束条件：**
- 不支持 SSL 2.0 或更低版本
- 不支持不加密的通信协议（如 HTTP 明文）

**重要性：** 确保数据传输安全性。

---

#### NFR-SEC-002: 用户认证安全
**作为系统**，用户认证应满足安全要求。

**接受条件：**
- 账号密码使用 bcrypt 单向加密哈希算法存储
- 登录会话超时时间为 24 小时
- 登录失败 5 次后账户锁定 10 分钟

**约束条件：**
- 单租户部署（MVP 阶段不支持多租户）
- 账号创建仅通过管理员操作
- 暂不支持 OAuth 等第三方登录方式

**重要性：** 确保系统访问安全性和防止暴力破解攻击。

---

### 可维护性要求

#### NFR-MAIN-001: 配置管理可维护性
**作为系统**，Beacon 配置管理应满足可维护性要求。

**接受条件：**
- 配置文件支持热更新（无需重启 Beacon）
- 配置文件变更在 10 秒内生效
- 配置文件验证错误时返回错误位置和修复建议

**约束条件：**
- 配置文件大小 ≤ 100KB
- 配置文件必须位于指定目录（默认 `/etc/beacon/` 或当前目录）

**重要性：** 确保配置管理的灵活性和可靠性。

---

#### NFR-MAIN-002: 日志与调试可维护性
**作为系统**，Beacon 的日志与调试功能应满足可维护性要求。

**接受条件：**
- Beacon 输出结构化日志（INFO/WARN/ERROR 级别）
- Beacon 支持调试模式，输出诊断信息（网络状态、配置解析、连接重试）
- 日志自动轮转，避免磁盘空间占满

**约束条件：**
- 日志文件大小 ≤ 10MB（轮转前）
- 日志保留时间 ≥ 7 天

**重要性：** 确保系统可观测性和故障排查能力。

---

### 资源约束

#### NFR-RES-001: Beacon 内存限制
**作为系统**，Beacon 的内存占用应满足资源限制要求。

**接受条件：**
- Beacon 内存占用 ≤ 100MB（在正常操作期间）
- 内存占用测量基于 `/proc/<pid>/status` RSS 字段，在 5 分钟窗口内平均计算
- 测试场景：10 个并发探测任务

**约束条件：**
- 在正常操作期间允许偶尔峰值超过 100MB
- 超过限制时告警并自动降级采集频率

**重要性：** 确保 Beacon 对监控节点的资源影响最小化。

---

#### NFR-RES-002: Beacon CPU 限制
**作为系统**，Beacon 的 CPU 占用应满足资源限制要求。

**接受条件：**
- Beacon CPU 占用 ≤ 100 微核（在空闲期间）
- CPU 占用测量基于 `/proc/<pid>/stat` CPU 时间，在 1 分钟窗口内平均计算
- 测试场景：无活跃探测任务

**约束条件：**
- 在探测任务执行期间允许 CPU 占用峰值
- 超过限制时告警并自动降级采集频率

**重要性：** 确保 Beacon 对监控节点的资源影响最小化。

---

## 项目范围与阶段化开发

### MVP 策略与理念

**MVP 类型**：问题解决型

**核心理念**：
- 验证 Beacon 与 Pulse 协同架构的可行性
- 最小化实现，专注于核心数据流：Beacon 探测上报 → Pulse 接收展示
- 运维主管部署节点，看到数据，通过告警响应异常

### MVP 功能集（阶段 1）

#### Pulse Beacon (CLI 工具)

**核心功能：**
- TCP/UDP Ping 探测
- 核心指标采集（时延、丢包率、抖动）
- 向 Pulse 上报数据（HTTP/HTTPS）
- 自动注册机制（启动时注册，获取 Node ID）
- 心跳上报（60 秒间隔）
- 本地 YAML 配置文件
- 配置热更新（无需重启）
- Prometheus Metrics 接口暴露
- CLI 命令（start/stop/status/debug）
- 日志系统（INFO/WARN/ERROR 级别输出）
- CPU/内存资源监控（≤100M，≤100 微核）

**配置管理：**
- 最小化 YAML 配置，支持基础配置字段
- 探测目标配置（IP、端口、协议、间隔）

#### Pulse (Web 平台)

**核心功能：**
- Beacon 注册管理（添加/删除/查看节点）
- 数据接收与存储（内存缓存 7 天数据）
- 仪表盘：
  - 全局视图（节点列表，红/黄/绿健康状态）
  - 单节点详情（时延、丢包率、抖动）
  - 问题类型判断（节点本地故障 vs. 跨境链路问题 vs. 运营商路由问题）
  - 完整配置管理界面：
  - 探测规则配置（阈值告警）
  - 节点信息管理（节点 ID、名称、地区、标签）
  - Webhook 告警推送：
    - Webhook URL 配置
    - 告警事件格式化推送
    - 推送失败记录与重试
- 健康检查（系统状态验证）

**基础认证：**
- 账号密码登录
- 单租户部署

**数据可视化：**
- 7 天历史趋势图
- 多节点对比视图

---

### Growth 功能（阶段 2）

#### Pulse Beacon 增强
- ICMP Ping 探测（可选协议）
- MTR 探测（逐跳路由分析）
- Traceroute 探测（多协议追踪）
- Iperf3 带宽测试
- 多视角探测配置（国内/海外运营商目标列表）
- 跨平台支持（Windows Server、Linux ARM64）

#### Pulse 增强
- 告警记录查询与管理（按节点/时间/级别筛选）
- 历史数据查看（7 天以上）
- 报表导出（CSV/Excel）
- 告警推送多渠道（邮件、钉钉、企业微信、短信）
- Prometheus Alertmanager 集成
- 配置模板管理（应用到新节点）

### 扩展功能（阶段 3 - 愿景）

#### 高级监控能力
- 业务流量抓包监控（被动监控核心业务端口）
- 自愈规则配置与下发（服务重启、端口重绑定、网络接口重置）
- 自愈执行状态监控与日志汇总

#### AI 与智能分析
- AI 异常模式识别（运营商割接、国际出口拥堵）
- 预测性告警（指标趋势预测）
- 路由绕路自动识别与告警
- 根因定位报告生成

#### 可观测性深化
- OTEL 支持（Beacon 和 Pulse）
- 高级仪表盘（跨境链路拓扑可视化）
- 性能基线自动生成与偏离预警

#### 多云适配
- AWS 节点适配（VPC 内探测、CloudWatch 指标对接）
- Azure 节点适配
- GCP 节点适配
- 云平台节点自动识别与标签
- 云平台专属监控模板

---

### 风险缓解策略

**技术风险：**
- Beacon 资源占用风险：监控 CPU/内存，超过限制时自动降级采集频率
- 跨境网络数据丢失风险：数据压缩 + 断点续传机制，网络恢复后自动同步数据
- ICMP 禁用环境风险：优先 TCP/UDP 探测，自动回退到 TCP/UDP

**市场风险：**
- MVP 功能精简可能影响用户初期体验 → 通过用户旅程验证，确保核心场景可用

**资源风险：**
- 小团队开发 → MVP 聚焦核心功能，避免过度工程
